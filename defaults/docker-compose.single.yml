# Generated by `iroha_swarm`.
# You should not edit this manually.
# Seed: Iroha

services:
  irohad0:
    image: hyperledger/iroha:2.0.0-rc.1.0
    pull_policy: if_not_present
    environment:
      CHAIN: 00000000-0000-0000-0000-000000000000
      PUBLIC_KEY: ed0120A36D508BDB1DBEFA4DF361F035A21DFD0F44C4DED67657537718DBF03C60E4C9
      PRIVATE_KEY: 8026205DF4A899B63A65CA3C093062D6BFBE3D6F6AA331FEAD82847FB95FE0DC7EE682
      P2P_PUBLIC_ADDRESS: irohad0:1337
      P2P_ADDRESS: 0.0.0.0:1337
      API_ADDRESS: 0.0.0.0:8080
      GENESIS_PUBLIC_KEY: ed01204164BF554923ECE1FD412D241036D863A6AE430476C898248B8237D77534CFC4
      GENESIS_PRIVATE_KEY: 80262082B3BDE54AEBECA4146257DA0DE8D59D8E46D5FE34887DCD8072866792FCB3AD
      GENESIS: /tmp/genesis.signed.scale
      TOPOLOGY: '["ed0120A36D508BDB1DBEFA4DF361F035A21DFD0F44C4DED67657537718DBF03C60E4C9"]'
      TRUSTED_PEERS: '["ed0120A36D508BDB1DBEFA4DF361F035A21DFD0F44C4DED67657537718DBF03C60E4C9@irohad0:1337","ed012082528CCC8727333530C8F6F19F70C23882DEB1BF2BA3BE4A6654C7E8A91A7731@iroha2-peer-0.iroha2-community.svc.cluster.local:1337","ed012083C85E315776FD2DDC187ECB23E608F800B313A1D614B108078EC048D5013D2D@iroha2-peer-1.iroha2-community.svc.cluster.local:1337","ed0120A37B7B758C952FE9429E9E35D1D71E2D8BB9364EDD077B5027ABAAC798D3230E@iroha2-peer-2.iroha2-community.svc.cluster.local:1337","ed0120B23E14F659B91736AAB980B6ADDCE4B1DB8A138AB0267E049C082A744471714E@iroha2-peer-3.iroha2-community.svc.cluster.local:1337","ed0120BE21D0F4A88194D922CF7FF8FDA50F0454F93603981B6B0D73A0231EA23BC8DC@iroha2-peer-4.iroha2-community.svc.cluster.local:1337","ed0120F3D556A9A44D11AD59275067D0691640C4BA4FF0F653C8C6B9396DE0F8208B64@iroha2-peer-5.iroha2-community.svc.cluster.local:1337","ed0120B0DF5B24B8A6959C93F791AB6852FFBE0EEEBD03BBF2564EDEC07C39BF419C14@iroha2-peer-6.iroha2-community.svc.cluster.local:1337"]'
    ports:
    - 1337:1337
    - 8080:8080
    volumes:
    - ./genesis.json:/config/genesis.json:ro
    - ./client.toml:/config/client.toml:ro
    init: true
    healthcheck:
      test: test $(curl -s http://127.0.0.1:8080/status/blocks) -gt 0
      interval: 2s
      timeout: 1s
      retries: 30
      start_period: 4s
    command: |-
      /bin/bash -c "
          EXECUTOR_RELATIVE_PATH=$(jq -r '.executor' /config/genesis.json) && \\
          EXECUTOR_ABSOLUTE_PATH=$(realpath \"/config/$$EXECUTOR_RELATIVE_PATH\") && \\
          WASM_DIR_RELATIVE_PATH=$(jq -r '.wasm_dir' /config/genesis.json) && \\
          WASM_DIR_ABSOLUTE_PATH=$(realpath \"/config/$$WASM_DIR_RELATIVE_PATH\") && \\
          jq \\
              --arg executor \"$$EXECUTOR_ABSOLUTE_PATH\" \\
              --arg wasm_dir \"$$WASM_DIR_ABSOLUTE_PATH\" \\
              --argjson topology \"$$TOPOLOGY\" \\
              '.executor = $$executor | .wasm_dir = $$wasm_dir | .topology = $$topology' /config/genesis.json \\
              >/tmp/genesis.json && \\
          kagami genesis sign /tmp/genesis.json \\
              --public-key $$GENESIS_PUBLIC_KEY \\
              --private-key $$GENESIS_PRIVATE_KEY \\
              --out-file $$GENESIS \\
          && \\
          exec irohad
      "
